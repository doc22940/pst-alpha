<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>WASM Test!</title>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack-subset.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.17.0/min/vs/loader.js"></script>
  <script src="dist/wasm_webgl2.js"></script>
  <script>
    "use strict";

    const monaco_vs_path = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.17.0/min/vs';
    require.config({ paths: { 'vs': monaco_vs_path } });

    window.MonacoEnvironment = {
      getWorkerUrl: (workerId, label) => {
        return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
          self.MonacoEnvironment = {
            baseUrl: '${monaco_vs_path}'
          };
          importScripts('${monaco_vs_path}/base/worker/workerMain.js');`
        )}`;
      }
    };

    const resizeCanvas = () => {
      const canvasContainerElem = document.getElementById("canvas-container");
      const canvasElem = document.getElementById("canvas");
      canvasElem.width = canvasContainerElem.clientWidth;
      canvasElem.height = canvasContainerElem.clientHeight;
    };

    const resizeEditor = () => {
      if (window.editor) window.editor.layout();
    };

    const updateLayout = () => {
      resizeCanvas();
      resizeEditor();
    };

    const getShaderSource = () => {
      return Module.UTF8ToString(Module._getShaderSource());
    };
    const setShaderSource = (src) => {
      const src_ptr = Module.allocateUTF8(src);
      Module._setShaderSource(src_ptr);
      Module._free(src_ptr);
    };

    let rendererPrevFrameTimeMillis = 0;
    let rendererTimeMillis = 0;
    let rendererTimeIsPaused = false;

    const initRenderer = () => {
      const idStringPtr = Module.allocateUTF8("canvas");
      Module._init(idStringPtr);
      Module._free(idStringPtr);

      const onFrame = (timestamp) => {
        const deltaTime = rendererPrevFrameTimeMillis === 0 ? 0 : timestamp - rendererPrevFrameTimeMillis;
        rendererPrevFrameTimeMillis = timestamp;

        if (!rendererTimeIsPaused) {
          rendererTimeMillis += deltaTime;
        }

        Module._update(rendererTimeMillis / 1000.0);
        Module._render();
        window.requestAnimationFrame(onFrame);
      };

      window.requestAnimationFrame(onFrame);
    };

    const init = () => {
      const paneLeftElem = document.getElementById("pane-left");
      const paneRightElem = document.getElementById("pane-right");

      const clamp = (x, min, max) => x < min ? min : x > max ? max : x;

      const setEditorWidthFraction = (widthFraction) => {
        const widthPercent = clamp(100 * widthFraction, 10, 90);
        paneLeftElem.style.right = (100 - widthPercent) + "%";
        paneRightElem.style.left = widthPercent + "%";
        window.localStorage.setItem("editorWidthFraction", widthFraction);
      };
      const initialEditorWidthFraction = window.localStorage.getItem("editorWidthFraction");
      if (initialEditorWidthFraction) {
        setEditorWidthFraction(initialEditorWidthFraction);
      }

      const resizeHandleElem = document.getElementById("pane-resize-handle");
      let resizeHandleDragOffsetX = 0;
      let resizeHandleDragStartEditorWidth = 0;
      let resizeHandlePrevClickTimeMillis = -1;
      let resizeHandleHasMovedSinceLastClick = false;
      const onMouseDown = (event) => {
        event.preventDefault();
        resizeHandleDragOffsetX = resizeHandleElem.offsetLeft - event.clientX;
        resizeHandleDragStartEditorWidth = paneLeftElem.clientWidth;
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      };
      const onMouseUp = (event) => {
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }
      const onMouseMove = (event) => {
        resizeHandleHasMovedSinceLastClick = true;
        const handleX = event.clientX + resizeHandleDragOffsetX;
        setEditorWidthFraction(handleX / document.body.clientWidth);
        updateLayout();
      };
      const onClick = (event) => {
        if (!resizeHandleHasMovedSinceLastClick && resizeHandlePrevClickTimeMillis >= 0 && event.timeStamp - resizeHandlePrevClickTimeMillis < 300) {
          setEditorWidthFraction(0.5);
          updateLayout();
          resizeHandlePrevClickTimeMillis = -1;
        }
        else if (resizeHandleHasMovedSinceLastClick) {
          resizeHandlePrevClickTimeMillis = -1;
          resizeHandleHasMovedSinceLastClick = false;
        }
        else {
          resizeHandlePrevClickTimeMillis = event.timeStamp;
        }
      };
      resizeHandleElem.addEventListener("mousedown", onMouseDown);
      resizeHandleElem.addEventListener("click", onClick);

      document.getElementById("rewind-button").addEventListener("click", (event) => {
        rendererPrevFrameTimeMillis = 0;
        rendererTimeMillis = 0;
      });
      document.getElementById("play-pause-button").addEventListener("click", (event) => {
        rendererTimeIsPaused = !rendererTimeIsPaused;
      });

      require(["vs/editor/editor.main"], () => {
        window.editor = monaco.editor.create(paneLeftElem, {
          value: getShaderSource(),
          theme: "vs-dark",
          fontFamily: "Hack",
          language: "c",
          dragAndDrop: false,
          folding: false,
          scrollBeyondLastLine: false,
          minimap: { enabled: false },
        });

        window.editor.addAction({
          id: "shader-run",
          label: "Run Shader",
          keybindings: [monaco.KeyMod.Alt | monaco.KeyCode.Enter, monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S],
          contextMenuGroupId: "shader",
          contextMenuOrder: 0,
          run: (editor) => {
            setShaderSource(editor.getValue());
          }
        });

        window.editor.onDidChangeModelContent((event) => {
          // setShaderSource(window.editor.getValue());
        });

        resizeEditor();
      });

      updateLayout();
    };

    Module.onRuntimeInitialized = initRenderer;

    window.addEventListener("load", init);
    window.addEventListener("resize", updateLayout);
  </script>
</head>

<body>
  <div id="pane-right">
    <div id="canvas-container">
      <canvas id="canvas" width="100" height="100"></canvas>
    </div>
    <div id="controls">
      <button id="rewind-button">Rewind</button>
      <button id="play-pause-button">Play/Pause</button>
    </div>
  </div>
  <div id="pane-left">
    <div id="pane-resize-handle"></div>
  </div>
</body>

</html>