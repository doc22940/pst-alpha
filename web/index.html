<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WASM Test!</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.17.0/min/vs/loader.js"></script>
  <script src="dist/wasm_webgl2.js"></script>
  <script>
    const monaco_vs_path = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.17.0/min/vs';
    require.config({ paths: { 'vs': monaco_vs_path }});

    window.MonacoEnvironment = {
      getWorkerUrl: (workerId, label) => {
        return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
          self.MonacoEnvironment = {
            baseUrl: '${monaco_vs_path}'
          };
          importScripts('${monaco_vs_path}/base/worker/workerMain.js');`
        )}`;
      }
    };

    const resizeCanvas = () => {
      const canvasContainerElem = document.getElementById("canvas-container");
      const canvasElem = document.getElementById("canvas");
      canvasElem.width = canvasContainerElem.clientWidth;
      canvasElem.height = canvasContainerElem.clientHeight;
    };

    const resizeEditor = () => {
      if (window.editor) window.editor.layout();
    };

    const updateLayout = () => {
      resizeCanvas();
      resizeEditor();
    };

    const getShaderSource = () => {
      return Module.UTF8ToString(Module._getShaderSource());
    };
    const setShaderSource = (src) => {
      const src_ptr = Module.allocateUTF8(src);
      Module._setShaderSource(src_ptr);
      Module._free(src_ptr);
    };

    const init = () => {
      resizeCanvas();

      const id_ptr = Module.allocateUTF8("canvas");
      Module._init(id_ptr);
      Module._free(id_ptr);

      const onFrame = (timestamp) => {
        Module._update(timestamp / 1000.0);
        Module._render();
        window.requestAnimationFrame(onFrame);  
      };

      window.requestAnimationFrame(onFrame);
      
      const canvasContainerElem = document.getElementById("canvas-container");
      const editorContainerElem = document.getElementById("editor-container");

      const resizeHandleElem = document.getElementById("editor-resize-handle");
      let resizeHandleDragStartX = 0;
      let resizeHandleDragStartEditorWidth = 0;
      const onMouseDown = (event) => {
        event.preventDefault();
        resizeHandleDragOffsetX = resizeHandleElem.offsetLeft - event.clientX;
        resizeHandleDragStartEditorWidth = editorContainerElem.clientWidth;
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      };
      const onMouseUp = (event) => {
        resizeHandleDragPointerId = -1;
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }
      const onMouseMove = (event) => {
        const handleX = event.clientX + resizeHandleDragOffsetX;
        const handlePercent = 100 * handleX / document.body.clientWidth;
        editorContainerElem.style.right = (100 - handlePercent) + "%";
        canvasContainerElem.style.left = handlePercent + "%";
        updateLayout();
      };
      resizeHandleElem.addEventListener("mousedown", onMouseDown);

      require(["vs/editor/editor.main"], () => {
        window.editor = monaco.editor.create(editorContainerElem, {
          value: getShaderSource(),
          theme: 'vs-dark',
          language: 'c',
          dragAndDrop: false,
          folding: false,
          scrollBeyondLastLine: false,
          minimap: { enabled: false },
        });

        window.editor.addAction({
          id: "shader-run",
          label: "Run Shader",
          keybindings: [ monaco.KeyMod.Alt | monaco.KeyCode.Enter, monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S ],
          contextMenuGroupId: "shader",
          contextMenuOrder: 0,
          run: (editor) => {
            setShaderSource(editor.getValue());
          }
        });

        window.editor.onDidChangeModelContent((event) => {
          // setShaderSource(window.editor.getValue());
        });

        resizeEditor();
      });
    };

    Module.onRuntimeInitialized = init;

    window.addEventListener('resize', () => {
      updateLayout();
    });
  </script>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
    }
    body {
      background-color: #1e1e1e;
    }
    #canvas-container {
      position: absolute;
      top: 0;
      left: 50%;
      right: 0;
      bottom: 0;
    }
    #editor-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 50%;
      bottom: 0;
    }
    #editor-resize-handle {
      position: absolute;
      top: 0;
      left: 100%;
      bottom: 0;
      right: -8px;
      cursor: col-resize;
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <canvas id="canvas" width="100" height="100"></canvas>
  </div>
  <div id="editor-container">
    <div id="editor-resize-handle"></div>
  </div>
</body>
</html>
